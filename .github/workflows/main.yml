name: Build and Deploy

on:
  push:
    branches:
      - main  # Запуск при пуше в main
  workflow_run:
    workflows:
      - "Build App"  # Завершающий workflow - сборка приложения
    types:
      - completed  # Запуск деплоя только после завершения работы билда

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Install dependencies
        run: |
          composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: Build Docker image
        run: docker build -t my-app .

      - name: Push Docker image
        run: docker push my-app

  deploy:
    runs-on: [self-hosted, macOs, X64]  # Используем self-hosted runner для деплоя

    needs: build  # Деплой зависит от успешного завершения сборки

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Remove old containers
        run: |
          export CONTAINER_PREFIX=photo_content
          docker stop $(docker ps -a | grep ${CONTAINER_PREFIX}_ | awk '{print $1}') || true
          docker rm $(docker ps -a | grep ${CONTAINER_PREFIX}_ | awk '{print $1}') || true
          sleep 5

      - name: Deploy to VPS
        run: |
          docker-compose up -d  # Запуск контейнеров с актуальной конфигурацией
